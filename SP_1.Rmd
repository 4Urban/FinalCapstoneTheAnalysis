---
title: "The SP survey"
output:
  html_document:
    df_print: paged
---

Start Date: 2020-11-07
Finish Date: Ongoing



### 전반적으로 쓰이는 패키지 호출
```{r, message=FALSE}
library(dplyr) #Data Modifying, Grouping, and so on
library(tidyr) #Reshape between Wide and Long form

library(mlogit) #Logit Model
library(lmtest) #Logit Model fittness

library(ggplot2) #Draw Plot
# library(plotly) #More detailed Plot
# library(gridExtra) #Show table in Plot
# library(ggpubr) #Show multiple Plots

library(showtext) #show Korean in Plot
#---cf. https://www.facebook.com/groups/krstudy/permalink/1546879218819678/?comment_id=1549629918544608
# system(command="wget wget http://cdn.naver.com/naver/NanumFont/fontfiles/NanumFont_TTF_ALL.zip")
# system(command="unzip NanumFont_TTF_ALL.zip -d NanumFont")
# system(command="rm -f NanumFont_TTF_ALL.zip")
# 
font_add(family="NanumGothic", regular="NanumFont/NanumGothic.ttf", bold="NanumFont/NanumGothicBold.ttf")
showtext_auto()
```


## 원시데이터 입력
### 설문 응답(.xlxs) 자료 입력

```{r}
colnm <- c("ResponseID", "TripL_mode_car", "TripL_mode_expbus", "TripL_mode_train", "TripL_mode_expt", "TripL_mode_plane", "TripL_mode_ship", "TripL_mode_none", "TripL_expt", "TripL_plane", "Trip_made", "Conv", "Eco", "Safe", "Trans", "New", "Sens", "SpA150_1", "SpA150_2", "SpA150_3", "SpA150_4", "SpA250_1", "SpA250_2", "SpA250_3", "SpA250_4", "SpA300_1", "SpA300_2", "SpA300_3", "SpA300_4", "SpB150_1", "SpB150_2", "SpB150_3", "SpB150_4", "SpB250_1", "SpB250_2", "SpB250_3", "SpB250_4", "SpB300_1", "SpB300_2", "SpB300_3", "SpB300_4", "Gender", "Byear", "HHsize", "Job", "Inc", "Ncars", "TypeError", "Type", "StartDate", "SubmitDate", "NetworkID")

coltp <- c("text", "text", "text", "text", "text", "text", "text", "text", "numeric", "numeric", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "numeric", "numeric", "text", "text", "text", "numeric", "text", "text", "text", "text")

library(readxl)
data <- suppressWarnings(
  read_excel("responses.xlsx", col_names=colnm, col_types=coltp, skip=1))
# View(data)

remove(colnm, coltp)
```


### 선택지 한국어 → 데이터화 기준

```{r}
library(readxl)
level <- read_excel("Level.xlsx")
option <- read_excel("Option.xlsx")
```


## 데이터 1차 가공

```{r}
# filter only needed columns
colnm_f <- c("ResponseID", "TripL_mode_car", "TripL_mode_expbus", "TripL_mode_train", "TripL_mode_expt", "TripL_mode_plane", "TripL_mode_ship", "TripL_mode_none", "TripL_expt", "TripL_plane", "Trip_made", "Conv", "Eco", "Safe", "Trans", "New", "Sens", "SpA150_1","SpA150_2", "SpA150_3", "SpA150_4", "SpA250_1", "SpA250_2", "SpA250_3", "SpA250_4", "SpA300_1", "SpA300_2", "SpA300_3", "SpA300_4", "SpB150_1", "SpB150_2", "SpB150_3", "SpB150_4", "SpB250_1", "SpB250_2", "SpB250_3", "SpB250_4", "SpB300_1", "SpB300_2", "SpB300_3", "SpB300_4", "Gender", "Byear", "HHsize", "Job", "Inc", "Ncars", "Type")

dt <- data[colnames(data) %in% colnm_f]
remove(colnm_f)


# convert T/F(NA) to 1/0
colnm_t <- c("TripL_mode_car", "TripL_mode_expbus", "TripL_mode_train", "TripL_mode_expt", "TripL_mode_plane", "TripL_mode_ship", "TripL_mode_none")

for(c in colnames(dt)){
  if(c %in% colnm_t){
    dt[[c]][!is.na(dt[[c]])] <- 1
    dt[[c]][is.na(dt[[c]])] <- 0
  }
}
remove(c, colnm_t)


# remove non-target-sample
dt <- dt[dt$TripL_mode_none == 0, ]


# convert Korean to Number(char)
for(c in colnames(option)[!(colnames(option) %in% c("Number", "SelectN"))]){
  for(i in which(!is.na(option[[c]]))){
    # cat(option[i, c], sep="\n")
    # cat(option[i, "Number"], sep="\n")
    dt[] <- lapply(dt, function(x) gsub(option[i, c], option[i, "Number"], x, fixed=TRUE)) #fixed=TRUE means non-regex
  }
}
remove(i, c)


# change Character to Number except columns(ResponseID, Type)
dt <- dt %>% mutate_at(vars(-ResponseID, -Type), as.numeric)


# change+add Byear to Age
dt$Age <- 2020 - dt$Byear
dt <- dt[, which(!(colnames(dt) == "Byear"))]
```


## 표본 특성

표본의 특성을 분석

Plot Template @[R graph gallery](https://www.r-graph-gallery.com/128-ring-or-donut-plot.html)

```{r}
AttType <- dt[, "Type"]
AttTrip <- dt[, match("TripL_mode_car", colnames(dt)):
                match("Trip_made", colnames(dt))]
AttLatent <- dt[, match("Conv", colnames(dt)):
                  match("Sens", colnames(dt))]
AttPerson <- dt[, match("Gender", colnames(dt)):
                  match("Age", colnames(dt))]

# Total Number of Samples
nOfSmp <- nrow(dt)

# Number of Types: A, B
AttType %>% count(Type)
```


### 개인 사회경제 변수

```{r, message=FALSE}
# Percentage of Gender: Male(1), Female(2)

# groups <- c(quo(Gender), quo(Age), quo(HHsize), quo(Job))
# for(i in seq_along(groups)){
#   AttPerson %>% group_by(!!groups[[i]]) %>%
#     summarise(percentage=round(n()/nOfSmp*100, 2)) %>%
#     print()
# }
# remove(groups)

getPlot <- function(Att, Criteria) {
test <- AttPerson %>% group_by(Gender) %>%
  summarise(count=n(), percentage=round(n()/nOfSmp*100,2))
test


# Compute the cumulative percentages (top of each rectangle)
test$ymax <- cumsum(test$percentage)

# Compute the bottom of each rectangle
test$ymin <- c(0, head(test$ymax, n=-1))

# Compute label position
test$labelPosition <- (test$ymax + test$ymin) / 2

# Compute a good label
test$label <- paste0(test$Gender, "\n", test$count, "명\n", test$percentage, "%")

# Make the plot
ggplot(test, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Gender)) + 
  geom_rect() + 
  geom_text(x=1, aes(y=labelPosition, label=label, color=Gender), size=6) + 
  # x: label position (inner / outer)
  coord_polar(theta="y") + # Pie Chart
  xlim(c(-1, 4)) + # Donut Hole
  theme_void() +
  theme(legend.position = "none", text=element_text(family="NanumGothic"))  
}


test <- AttPerson %>% group_by(Gender) %>%
  summarise(count=n(), percentage=round(n()/nOfSmp*100,2))
test


# Compute the cumulative percentages (top of each rectangle)
test$ymax <- cumsum(test$percentage)

# Compute the bottom of each rectangle
test$ymin <- c(0, head(test$ymax, n=-1))

# Compute label position
test$labelPosition <- (test$ymax + test$ymin) / 2

# Compute a good label
test$label <- paste0(test$Gender, "\n", test$count, "명\n", test$percentage, "%")

# Make the plot
ggplot(test, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Gender)) + 
  geom_rect() + 
  geom_text(x=1, aes(y=labelPosition, label=label, color=Gender), size=6) + 
  # x: label position (inner / outer)
  coord_polar(theta="y") + # Pie Chart
  xlim(c(-1, 4)) + # Donut Hole
  theme_void() +
  theme(legend.position = "none", text=element_text(family="NanumGothic"))

AttPerson %>% group_by(Age) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttPerson %>% group_by(HHsize) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttPerson %>% group_by(Job) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))
```


### 개인 통행특성 변수

```{r, message=FALSE}
# Have_experienced(1), None(0)
AttTrip %>% group_by(TripL_mode_car) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttTrip %>% group_by(TripL_mode_expbus) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttTrip %>% group_by(TripL_mode_train) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttTrip %>% group_by(TripL_mode_expt) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttTrip %>% group_by(TripL_mode_plane) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttTrip %>% group_by(TripL_mode_ship) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttTrip %>% group_by(TripL_expt) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttTrip %>% group_by(TripL_plane) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))
```


### 개인 성향 변수

```{r, message=FALSE}
AttLatent %>% group_by(Conv) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttLatent %>% group_by(Eco) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttLatent %>% group_by(Safe) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttLatent %>% group_by(Trans) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttLatent %>% group_by(New) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))

AttLatent %>% group_by(Sens) %>%
  summarise(percentage=round(n()/nOfSmp*100,2))
```

### 불필요한 변수 삭제

```{r}
remove(data, nOfSmp, AttType, AttPerson, AttTrip ,AttLatent)
```



## 로짓 모형

### 데이터 2차 가공 merge with Alternative Specific Variables' levels

```{r}
colnm_sp <- c("SpA150_1","SpA150_2", "SpA150_3", "SpA150_4", "SpA250_1", "SpA250_2", "SpA250_3", "SpA250_4", "SpA300_1", "SpA300_2", "SpA300_3", "SpA300_4", "SpB150_1", "SpB150_2", "SpB150_3", "SpB150_4", "SpB250_1", "SpB250_2", "SpB250_3", "SpB250_4", "SpB300_1", "SpB300_2", "SpB300_3", "SpB300_4")

dtMerged <- dt %>% gather_('Question', 'Select', colnm_sp)
remove(colnm_sp)


# enter the "level" according to the Question Type
level$Question <- paste("Sp", level$Type, level$Dist, "_", level$Qq_ID, sep="")

# dtLong$Qtype <- substr(dtLong$Question, 3, 3)
# dtLong$Qdist <- as.numeric(substr(dtLong$Question, 4, 6))
# dtLong$QqqID <- as.numeric(substr(dtLong$Question, 8, 8))

dtMerged <- merge(dtMerged, level[, which(colnames(level)=="Dist"):ncol(level)], 
           by="Question")


# remove non-answered-question
dtMerged <- dtMerged[!is.na(dtMerged$Select), ]


# convert Number to Name(character)
# tbl <- cbind()
dtMerged <- merge(dtMerged, option[which(!is.na(option["SpN"])),
                                   which(colnames(option) %in% c("Number", "SpN"))], by.x="Select", by.y="Number")

# filter unneeded columns
dtMerged <- dtMerged[, which(!(colnames(dtMerged) %in% c("Select", "Question", "TripL_mode_none", "Type")))]

# change 'SpN' column name to 'Choice'
dtMerged <- rename(dtMerged, "Choice"="SpN")

str(dtMerged)
remove(dt, level, option)
```


### 응답 특성

```{r}
AttSp <- dtMerged[, which(colnames(dtMerged) %in% c("Dist", "Choice"))]

# Total Number of Samples
nOfSmp <- AttSp %>% count(Dist)
nOfSmp <- nOfSmp[1, 2]

# Number of Choices by Distance: expt, plane, hyper
AttSp %>% group_by(Dist, Choice) %>%
  summarise(count=n(), percentage=round(n()/nOfSmp*100,2))
AttSp %>% group_by(Choice) %>%
  summarise(count=n(), percentage=round(n()/nrow(AttSp)*100,2))
# 
# SmmAttSp[which(SmmAttSp$Dist == 150), ]
# # Percentage of Gender: Male(1), Female(2)
# 
# 
# test <- AttPerson %>% group_by(Gender) %>%
#   summarise(count=n(), percentage=round(n()/nOfSmp[1,2]*100,2))
# test
# 
# 
# # Compute the cumulative percentages (top of each rectangle)
# test$ymax <- cumsum(test$percentage)
# 
# # Compute the bottom of each rectangle
# test$ymin <- c(0, head(test$ymax, n=-1))
# 
# # Compute label position
# test$labelPosition <- (test$ymax + test$ymin) / 2
# 
# # Compute a good label
# test$label <- paste0(test$Gender, "\n", test$count, "명\n", test$percentage, "%")
# 
# # Make the plot
# ggplot(test, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=Gender)) + 
#   geom_rect() + 
#   geom_text(x=1, aes(y=labelPosition, label=label, color=Gender), size=6) + 
#   # x: label position (inner / outer)
#   coord_polar(theta="y") + # Pie Chart
#   xlim(c(-1, 4)) + # Donut Hole
#   theme_void() +
#   theme(legend.position = "none", text=element_text(family="NanumGothic"))
# 
# AttPerson %>% group_by(Age) %>%
#   summarise(percentage=round(n()/nOfSmp*100,2))
# 
# AttPerson %>% group_by(HHsize) %>%
#   summarise(percentage=round(n()/nOfSmp*100,2))
# 
# AttPerson %>% group_by(Job) %>%
#   summarise(percentage=round(n()/nOfSmp*100,2))
```




### 데이터 3차 가공 to mlogit.Wide form

mlogit [기본 설명](https://cran.r-project.org/web/packages/mlogit/vignettes/c2.formula.data.html)

분석 및 해석하는 방법 [@Youtube](https://youtu.be/-Cp_KP9mq94)

```{r}
# Divide by Distance
dtMergedD <- dtMerged %>% group_split(Dist)


# Convert those to mlogit.Wide form
vars <- which(colnames(dtMerged) %in% c("Time_expt", "Time_plane", "Time_hyper", "Cost_expt", "Cost_plane", "Cost_hyper"))

dtWide <- mlogit.data(dtMerged, shape="wide", choice="Choice", varying=vars, sep="_", id.var="ResponseID", opposite=c("Cost", "Time"))
dtWide250 <- mlogit.data(as.data.frame(dtMergedD[[2]]), shape="wide", choice="Choice", varying=vars, sep="_", id.var="ResponseID", opposite=c("Cost", "Time"))


# without Plane in 150km
varsP <- which(colnames(dtMerged) %in% c("Time_expt", "Time_hyper", "Cost_expt", "Cost_hyper"))

dtWide150 <- mlogit.data(as.data.frame(dtMergedD[[1]]), shape="wide", choice="Choice", varying=varsP, sep="_", id.var="ResponseID", opposite=c("Cost", "Time"))


# without Expt in 300km
varsE <- which(colnames(dtMerged) %in% c("Time_plane", "Time_hyper", "Cost_plane", "Cost_hyper"))

dtExcept <- dtMergedD[[3]][dtMergedD[[3]][, "Choice"] != "expt", ]
dtWide300 <- mlogit.data(as.data.frame(dtExcept), shape="wide", choice="Choice", varying=varsE, sep="_", id.var="ResponseID", opposite=c("Cost", "Time"))


# head(index(dtWide))
#---chid: choice situation index
#---alt: alternative index
#---id: individual index

# head(dtWide)
# dtWide[1:10, ]
remove(vars)
remove(varsP)
remove(varsE)
```

- `character` 문자형

- `categorical` 범주형
  - `t/f` 참/거짓
  - `nominal` 명칭척도
  - `ordinal` 순위척도  
  
- `continuous` 연속형
  - `interval` 간격척도
  - `ratio` 비율척도

***

|이름 | 유형  | 설명  | 내용  |
-|-|-|-
|`ResponseID       ` | char  | 응답ID  | 고유값 |
|`TripL_mode_car   ` | t/f  | 3개년 내 장거리 승용차/승합차 탑승 여부 | 참/거짓 |
|`TripL_mode_expbus` | t/f  | 3개년 내 장거리 고속·시외버스 탑승 여부 | 참/거짓 |
|`TripL_mode_train ` | t/f  | 3개년 내 장거리 일반철도 탑승 여부 | 참/거짓 |
|`TripL_mode_expt  ` | t/f  | 3개년 내 장거리 고속철도 탑승 여부 | 참/거짓 |
|`TripL_mode_plane ` | t/f  | 3개년 내 장거리 항공 탑승 여부 | 참/거짓 |
|`TripL_mode_ship  ` | t/f  | 3개년 내 장거리 선박 탑승 여부 | 참/거짓 |
|`TripL_expt       ` | t/f  | 3개년 내 고속철도 탑승 여부 | 참/거짓 |
|`TripL_plane      ` | t/f  | 3개년 내 항공 장거리 탑승 여부 | 참/거짓 |
|`Trip_made        ` | num  | 월 평균 장거리 이동 왕복 횟수  | 횟수 |
|`Conv             ` | ordi  | 편의성 | 1 < 7 |
|`Eco              ` | ordi  | 친환경성  | 1 < 7 |
|`Safe             ` | ordi  | 안전성  | 1 < 7 |
|`Trans            ` | ordi  | 환승 여부  | 1 < 7 |
|`New              ` | ordi  | 최신 기술 사용 여부 | 1 < 7 |
|`Sens             ` | ordi  | 감성 | 1 < 7 |
|`Gender           ` | nomi  | 성별 | 남자, 여자 |
|`HHsize           ` | num  | 가구원수 | 명수 |
|`Job              ` | nomi  | 직업 | 무직/학생(8) |
|`Inc              ` | inte  | 소득 | 100만원 미만(1) |
|`Ncars            ` | t/f  | 자가용 보유 여부  | 참/거짓 |
|`Age              ` | rati  | 나이  | 나이 |
|`Dist             ` | rati  | 거리  | km |
|`Time             ` | rati  | 시간  | 분 |
|`Cost             ` | rati  | 비용  | 원 |
|`Choice           ` | nomi  | 선택  | 고속철도(expt), 항공(plane), 하이퍼루프(hyper) |



### 효용함수 설정

```{r}
f <- mFormula(Choice ~ Cost | Gender + HHsize + Job + Inc + Ncars + Age + TripL_mode_car + TripL_mode_expbus + TripL_mode_train + TripL_mode_expt + TripL_mode_plane + TripL_expt + TripL_plane + Trip_made + Conv + Eco + Safe + Trans + New + Sens | Time)
f <- mFormula(Choice ~ Cost | Gender + HHsize + Job + Inc + Ncars + Age + Conv + Eco + Safe + Trans + New + Sens | Time)
# f <- mFormula(Choice ~ Cost | Gender + HHsize + Job + Inc + Ncars + Age | Time)
# f <- mFormula(Choice ~ Cost | Gender + HHsize + Inc + Ncars + Age | Time)
# f <- mFormula(Choice ~ Cost + Dist | Gender + HHsize + Inc + Age | Time)
# f <- mFormula(Choice ~ Cost + Dist | Gender + HHsize + Inc | Time)

# Dist 넣으면 에러 발생
# f <- mFormula(Choice ~ Dist | Gender + HHsize + Inc | Time)
```


### 로짓모형

```{r}
m <- mlogit(f, dtWide, reflevel="hyper")
summary(m)

# #fitted: estimated "probabilities to choose each specific mode"
# apply(fitted(m, type="probabilities", outcome=FALSE), 2, mean)

# mn <- with(m, data.frame(Cost=tapply(Cost, index(m)$Choice, mean)))

# lrtest(m)
# waldtest(m)
# scoretest(m)
# 
# 
# statpval <- function(x){
#     if (inherits(x, "anova")) result <- as.matrix(x)[2, c("Chisq", "Pr(>Chisq)")]
#     if (inherits(x, "htest")) result <- c(x$statistic, x$p.value)
#     names(result) <- c("stat", "p-value")
#     round(result, 3)
# }
# 
# statpval(m)
```


```{r}
m <- mlogit(f, dtWide150, reflevel="hyper")
summary(m)

#fitted: estimated "probabilities to choose each specific mode"
# apply(fitted(m, type="probabilities", outcome=FALSE), 2, mean)
```

```{r}
m <- mlogit(f, dtWide250, reflevel="hyper")
summary(m)

#fitted: estimated "probabilities to choose each specific mode"
# apply(fitted(m, type="probabilities", outcome=FALSE), 2, mean)
```
```{r}
m <- mlogit(f, dtWide300, reflevel="hyper")
summary(m)

#fitted: estimated "probabilities to choose each specific mode"
# apply(fitted(m, type="probabilities", outcome=FALSE), 2, mean)
```


### 성향 변수 사이의 상관관계 확인

```{r}
plot(AttLatent)

library(corrplot)
corrplot.mixed(cor(AttLatent), upper = "ellipse", lower.col = "black")
```


### 다중공선성 확인

[참고자료](https://mindscale.kr/course/basic-stat-r/collinearity)

```{r}
library(car)
data <- subset(dtWide, select = -c(chas, rad))
lmfit <- lm(medv ~ . , data = data)
vif(m)

```

